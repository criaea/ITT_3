<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Millennium Profile</title>
    <!-- Loading Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Loading D3.js for the chart --><script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* D3 Chart text styling */
        .chart-label-title {
            font-size: 1.5rem; /* Tailwind text-2xl equivalent */
            font-weight: 700; /* Tailwind font-bold equivalent */
            fill: white;
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
            text-anchor: middle; /* Center text horizontally */
        }
        .chart-label-score {
            font-size: 1.25rem; /* Tailwind text-xl equivalent */
            font-weight: 500; /* Tailwind font-medium equivalent */
            fill: white;
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
            text-anchor: middle; /* Center text horizontally */
        }
        
        /* --- New Drag and Drop Styles --- */
        /* The draggable word itself */
        .draggable-word {
            padding: 0.75rem;
            background-color: white;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            cursor: grab;
            transition: all 0.2s ease;
            text-align: center;
            font-weight: 500;
        }
        
        .draggable-word:active {
            cursor: grabbing;
        }

        /* Style for the item being dragged */
        .dragging {
            opacity: 0.5;
            background: #f0f9ff; /* light-blue-50 */
            border: 1px dashed #0284c7; /* blue-600 */
        }

        /* The empty spot to drop into */
        .drop-spot {
            padding: 1rem;
            border: 2px dashed #9ca3af; /* gray-400 */
            border-radius: 0.5rem; /* rounded-lg */
            min-height: 80px; /* Give it a minimum height */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            background-color: #f9fafb; /* gray-50 */
        }
        
        .drop-spot-label {
            font-weight: 600;
            color: #4b5563; /* gray-600 */
        }
        
        .drop-spot-subtext {
            font-size: 0.875rem;
            color: #6b7280; /* gray-500 */
        }

        /* When dragging OVER a spot */
        .drop-spot.highlight,
        .word-bank-dropzone.highlight {
            background-color: #dbeafe; /* blue-100 */
            border-color: #3b82f6; /* blue-500 */
        }

        /* When a spot is FILLED */
        .drop-spot-filled {
            border-style: solid;
            border-color: #10b981; /* green-500 */
            background-color: #ecfdf5; /* green-50 */
            padding: 0.5rem; /* Reduce padding when filled */
        }

        .drop-spot-filled .drop-spot-label,
        .drop-spot-filled .drop-spot-subtext {
            display: none; /* Hide placeholder text */
        }
        
        /* The word bank on the right */
        .word-bank-dropzone {
            padding: 1rem;
            background-color: #f3f4f6; /* gray-100 */
            border: 2px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* space-y-3 */
        }

        /* --- Style for Key Words list --- */
        .key-word-rank-1 { font-weight: 700; color: #1f2937; } /* bold, gray-800 */
        .key-word-rank-2 { font-weight: 500; color: #374151; } /* medium, gray-700 */
        .key-word-rank-3 { font-weight: 400; color: #4b5563; opacity: 0.9; } /* normal, gray-600 */
        .key-word-rank-4 { font-weight: 300; color: #6b7280; opacity: 0.8; } /* light, gray-500 */
        
        /* --- NEW: Interactive Tab Styles --- */
        .style-tab {
            padding: 0.75rem 1.5rem;
            font-size: 1.125rem;
            font-weight: 600;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #4b5563; /* gray-600 */
            background-color: #f3f4f6; /* gray-100 */
            border: 2px solid #e5e7eb; /* gray-200 */
        }
        
        /* Active state for tabs */
        .style-tab.active-blue {
            background-color: #dbeafe; /* blue-100 */
            color: #1d4ed8; /* blue-700 */
            border-color: #93c5fd; /* blue-300 */
        }
        .style-tab.active-red {
            background-color: #fee2e2; /* red-100 */
            color: #b91c1c; /* red-700 */
            border-color: #fca5a5; /* red-300 */
        }
        .style-tab.active-green {
            background-color: #dcfce7; /* green-100 */
            color: #15803d; /* green-700 */
            border-color: #86efac; /* green-300 */
        }
        .style-tab.active-yellow {
            background-color: #fef9c3; /* yellow-100 */
            color: #a16207; /* yellow-700 */
            border-color: #fde047; /* yellow-300 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8 min-h-screen flex items-center justify-center">

    <!-- Main Test Page Container --><main id="test-page" class="container bg-white rounded-xl shadow-2xl p-6 md:p-10 w-full max-w-4xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-3 text-blue-700">Millennium Profile</h1>
        <p class="text-center text-gray-600 mb-8">
            For each question, drag the words from the "Word Choices" into the slots on the right.
        </p>

        <!-- New Question Counter -->
        <p id="question-counter" class="text-center text-lg font-semibold text-gray-700 mb-4"></p>

        <!-- Questions Container --><div id="questions-container" class="space-y-6">
            <!-- All 24 questions will be rendered here by JS, but hidden -->
        </div>

        <!-- Navigation/Action Buttons -->
        <div class="mt-10 flex flex-col items-center justify-center gap-4">
            
            <!-- Developer Fill Button -->
            <button id="dev-fill-button" 
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all duration-300 w-full sm:w-auto">
                Developer: Random Fill
            </button>
            
            <!-- Navigation buttons -->
            <div class="flex flex-row justify-center gap-4 w-full sm:w-auto">
                <button id="prev-button" 
                        class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all duration-300 w-1/2 sm:w-auto">
                    Previous
                </button>
                <button id="next-button" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all duration-300 w-1/2 sm:w-auto"
                        disabled>
                    Next
                </button>
            </div>
            
            <!-- Save Button (hidden initially) -->
            <button id="save-button" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed w-full sm:w-auto"
                    disabled style="display: none;">
                Show Results
            </button>
        </div>
        <p id="error-message" class="text-red-600 font-semibold mt-4 h-6 text-center"></p>
        <p id="success-message" class="text-green-600 font-semibold mt-4 h-6 text-center"></p>
    </main>

    <!-- Results Page Container (hidden by default) 
    --><div id="results-page" class="hidden fixed inset-0 bg-gray-100 p-4 overflow-y-auto">
        <div class="container bg-white rounded-xl shadow-2xl p-6 md:p-10 w-full max-w-5xl mx-auto flex flex-col items-center my-auto">
            
            <!-- Section 1: Pie Chart (First Item) -->
            <div class="w-full mb-8">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-4">Your Profile Proportions</h2>
                <div id="pie-chart-container" class="w-full h-[60vh] max-w-lg mx-auto overflow-hidden">
                    <svg id="pie-chart" class="w-full h-full"></svg>
                </div>
            </div>

            <!-- Section 2: Quadrant Chart (Rectangle Avg) -->
            <div class="w-full mb-12">
                 <h2 class="text-3xl font-bold text-center text-gray-800 mb-4">Your Score Quadrant</h2>
                 <div id="quadrant-chart-rect-container" class="w-full h-[70vh] max-w-2xl mx-auto overflow-hidden">
                    <svg id="quadrant-chart-rect" class="w-full h-full"></svg>
                 </div>
            </div>

            <!-- Section 3: Profile Title Section -->
            <div id="profile-title-container" class="text-center border-t-2 border-gray-200 pt-10 pb-6 mb-6 w-full">
                <!-- Content will be generated by JS -->
            </div>

            <!-- Section 4: At a Glance Section -->
            <div id="at-a-glance-container" class="w-full mb-8">
                <!-- Content will be generated by JS -->
            </div>
            
            <!-- Section 5: Key Words Quadrant -->
            <div class="w-full mb-12">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Your Key Word Quadrant</h2>
                <div id="key-words-grid" class="grid grid-cols-1 md:grid-cols-2 gap-px bg-gray-300 rounded-lg shadow-md overflow-hidden" style="transition: all 0.5s ease; min-height: 80vh;">
                    <div class="bg-blue-100 p-6 overflow-y-auto"> 
                        <h3 class="text-2xl font-bold text-blue-800 mb-3">BLUE</h3>
                        <div id="blue-key-words"></div>
                    </div>
                    <div class="bg-red-100 p-6 overflow-y-auto">
                        <h3 class="text-2xl font-bold text-red-800 mb-3">RED</h3>
                        <div id="red-key-words"></div>
                    </div>
                    <div class="bg-green-100 p-6 overflow-y-auto">
                        <h3 class="text-2xl font-bold text-green-800 mb-3">GREEN</h3>
                        <div id="green-key-words"></div>
                    </div>
                    <div class="bg-yellow-100 p-6 overflow-y-auto">
                        <h3 class="text-2xl font-bold text-yellow-800 mb-3">YELLOW</h3>
                        <div id="yellow-key-words"></div>
                    </div>
                </div>
            </div>

            <!-- Section 6: Strengths & Blind Spots Section -->
            <div id="strengths-blindspots-container" class="w-full mb-12">
                 <!-- Content will be generated by JS -->
            </div>

            <!-- Section 7: Communication Section -->
            <div id="communication-container" class="w-full mb-12">
                 <!-- Content will be generated by JS -->
            </div>

            <!-- NEW Section 8: Interactive Style Explorer -->
            <div class="w-full mt-12">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Explore the Full Style Summary</h2>
                
                <!-- Tab Buttons -->
                <div id="style-explorer-tabs" class="flex flex-wrap justify-center gap-4 mb-6">
                    <button class="style-tab" data-color="blue">BLUE</button>
                    <button class="style-tab" data-color="red">RED</button>
                    <button class="style-tab" data-color="green">GREEN</button>
                    <button class="style-tab" data-color="yellow">YELLOW</button>
                </div>
                
                <!-- Tab Content Area -->
                <div id="style-explorer-content" class="bg-gray-50 p-6 md:p-8 rounded-lg shadow-inner">
                    <!-- Content will be generated by JS -->
                </div>
            </div>
            
            <div class="text-center mt-12">
                <button id="back-to-test-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all duration-300">
                    Back to Test
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- PAGE ELEMENTS ---
        const testPage = document.getElementById('test-page');
        const resultsPage = document.getElementById('results-page');
        const questionsContainer = document.getElementById('questions-container');
        const saveButton = document.getElementById('save-button');
        const successMessage = document.getElementById('success-message');
        const errorMessage = document.getElementById('error-message');
        const backToTestButton = document.getElementById('back-to-test-button');
        const devFillButton = document.getElementById('dev-fill-button');
        
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const questionCounter = document.getElementById('question-counter');
        const styleExplorerTabs = document.getElementById('style-explorer-tabs');
        const styleExplorerContent = document.getElementById('style-explorer-content');

        // --- STATE ---
        let currentQuestionIndex = 0;
        const totalQuestions = 24;
        let draggedItem = null;

        // --- NEW: ALL PROFILE DATA (NOW WITH FULL SUMMARY) ---
        const profileDataStore = {
            blue: {
                title: "The Observer",
                summary: "Blue behaviour is motivated by strong needs for procedure and task-focus.",
                atAGlance: {
                    "Behaviour Pattern": "Self-Contained / Indirect",
                    "Pace": "Slow / Systematic",
                    "Priority": "The Task: the process",
                    "Fears": "Conflict / Embarrassment",
                    "Motivated by": "Procedures",
                    "Management Style": "Rule Adherence",
                    "Communication Style": "Writes",
                    "Under Tension": "Withdraw / Avoid",
                    "Irritated By": "Surprises, Unpredictability"
                },
                strengths: ["Compliant", "Careful", "Systematic", "Precise", "Accurate", "Perfectionist", "Logical"],
                blindSpots: ["Withdraw / Avoid (under tension)", "Irritated by surprises / unpredictability", "Can be firm, persistent, or stubborn (Low D)", "Fears Conflict"],
                communicationTips: [
                    "Send full written details in advance of your meeting.",
                    "Go the extra mile on preparation so you can answer all their questions when you meet.",
                    "Greet them in a business-like and civil way, and move to the task immediately.",
                    "Present your case in a practical, logical and paced way.",
                    "Pause to regularly ask questions to draw the Blue out.",
                    "Support with facts and figures and demonstrate application.",
                    "Don't go for a quick answer. Give the Blue time to think. Don't push.",
                    "Make sure they get both sides of the story - and don't hold back information."
                ],
                fullSummary: {
                    "Behaviour Pattern": "Self-Contained / Indirect",
                    "Appearance": "Formal, Conservative",
                    "Work-Space": "Structured, Organised, Functional, Formal",
                    "Pace": "Slow/Systematic",
                    "Priority": "The Task: the process",
                    "Fears": "Embarrassment",
                    "Under Tension Will": "Withdraw/Avoid",
                    "Seeks": "Accuracy",
                    "Needs to Know (Benefits)": "How they justify the purchase logically. How it works.",
                    "Gains Security By": "Preparation",
                    "Wants to Maintain": "Credibility",
                    "Support Their": "Thoughts",
                    "Achieves Acceptance By": "Correctness, Thoroughness",
                    "Likes You to Be": "Precise",
                    "Wants to Be": "Correct",
                    "Irritated By": "Surprises, Unpredictability",
                    "Measures Personal Worth By": "Precision, Accuracy, Activity",
                    "Decisions Are": "Deliberate"
                }
            },
            red: {
                title: "The Director",
                summary: "Red behaviour is motivated by strong needs for power and independence.",
                atAGlance: {
                    "Behaviour Pattern": "Self-Contained / Direct",
                    "Pace": "Fast / Decisive",
                    "Priority": "The Task: the results",
                    "Fears": "Failure / Loss of control",
                    "Motivated by": "Power",
                    "Management Style": "Directing",
                    "Communication Style": "Tells",
                    "Under Tension": "Dictate / Assert",
                    "Irritated By": "Inefficiency, Indecision"
                },
                strengths: ["Driving", "Competitive", "Forceful", "Inquisitive", "Direct", "Self-starter", "Assertive"],
                blindSpots: ["Dictate / Assert (under tension)", "Irritated by inefficiency / indecision", "Can be hesitant, mild, or non-demanding (Low A)", "Fears Failure"],
                communicationTips: [
                    "Expect to receive a hostile reception. Be prepared for scepticism, anger, belligerence, and impatience.",
                    "Stress the importance of benefits that provide autonomy, control, freedom of action and prestige.",
                    "Let the seam out; allow him to talk out vested certainties.",
                    "Keep calm; don't ride to the bait and don't let the customer upset you.",
                    "Be convincing and show strength, without becoming argumentative or aggressive.",
                    "Never argue; try to understand and then reason.",
                    "Use open-ended questions summarise and reflect. Avoid leading questions.",
                    "Allow the Red to take the credit-even if the ideas are yours. But don't make it obvious."
                ],
                fullSummary: {
                    "Behaviour Pattern": "Self-contained/Direct",
                    "Appearance": "Businesslike, Functional",
                    "Work-Space": "Busy, Formal, Efficient, Structured",
                    "Pace": "Fast/Decisive",
                    "Priority": "The Task: the results",
                    "Fears": "Loss of control",
                    "Under Tension Will": "Dictate/Assert",
                    "Seeks": "Productivity",
                    "Needs to Know (Benefits)": "What it does. By when. What it costs.",
                    "Gains Security By": "Control",
                    "Wants to Maintain": "Success",
                    "Support Their": "Goals",
                    "Achieves Acceptance By": "Leadership, Competition",
                    "Likes You to Be": "To the point",
                    "Wants to Be": "In charge",
                    "Irritated By": "Inefficiency, Indecision",
                    "Measures Personal Worth By": "Results, Track record, Measurable progress",
                    "Decisions Are": "Decisive"
                }
            },
            green: {
                title: "The Supporter",
                summary: "Green behaviour is motivated by strong needs for security and one-to-one relationships.",
                atAGlance: {
                    "Behaviour Pattern": "Open / Indirect",
                    "Pace": "Slow / Easy",
                    "Priority": "Maintaining relationships",
                    "Fears": "Insecurity / Confrontation",
                    "Motivated by": "Security",
                    "Management Style": "Procedural",
                    "Communication Style": "Listens",
                    "Under Tension": "Submit / Acquiesce",
                    "Irritated By": "Insensitivity, Impatience"
                },
                strengths: ["Dependable", "Deliberate", "Amiable", "Persistent", "Good Listener", "Kind"],
                blindSpots: ["Submit / Acquiesce (under tension)", "Irritated by insensitivity / impatience", "Can be mobile, alert, active, or restless (Low C)", "Fears Confrontation"],
                communicationTips: [
                    "Stress the importance of benefit that provide low risk stability, guarantees, permanence and solid value.",
                    "Be patient and slow down. Don't rush. Don't turn the screw.",
                    "Be concerned; let the Green know you're not there just for your own interests.",
                    "Expect the Green to be apprehensive, distrustful and uncommunicative.",
                    "Establish trust. Use genuine third party referrals.",
                    "Support the process gently and firmly. The Green won't take the lead but lead in a low-key, unhurried manner.",
                    "Let the Green keep it's self-respect. Don't pressurise.",
                    "Rely mainly on open-ended questions, reflective pauses and brief statements; don't drive on with close-ended questions.",
                    "Be ready to change if the Green's behaviour changes."
                ],
                fullSummary: {
                    "Behaviour Pattern": "Open/Indirect",
                    "Appearance": "Casual, Conforming",
                    "Work-Space": "Personal, Relaxed, Friendly, Informal",
                    "Pace": "Slow/Easy",
                    "Priority": "Maintaining relationships",
                    "Fears": "Confrontation",
                    "Under Tension Will": "Submit/Acquiesce",
                    "Seeks": "Attention",
                    "Needs to Know (Benefits)": "How it will affect their personal circumstances.",
                    "Gains Security By": "Close relationships",
                    "Wants to Maintain": "Relationships",
                    "Support Their": "Feelings",
                    "Achieves Acceptance By": "Conformity, Loyalty",
                    "Likes You to Be": "Pleasant",
                    "Wants to Be": "Liked",
                    "Irritated By": "Insensitivity, Impatience",
                    "Measures Personal Worth By": "Compatibility with others, Depth of relationships",
                    "Decisions Are": "Considered"
                }
            },
            yellow: {
                title: "The Inspirer",
                summary: "Yellow customer behaviour is motivated by deep-felt social needs supported by a strong self-esteem requirement.",
                atAGlance: {
                    "Behaviour Pattern": "Open / Direct",
                    "Pace": "Fast / Spontaneous",
                    "Priority": "Relationships",
                    "Fears": "Rejection / Loss of prestige",
                    "Motivated by": "Recognition",
                    "Management Style": "Leading",
                    "Communication Style": "Sell",
                    "Under Tension": "Attack / Be sarcastic",
                    "Irritated By": "Boredom, Routine"
                },
                strengths: ["Influential", "Persuasive", "Friendly", "Verbal", "Communicative", "Positive"],
                blindSpots: ["Attack / Be sarcastic (under tension)", "Irritated by boredom / routine", "Can be reserved, reflective, or suspicious (Low B)", "Fears Rejection"],
                communicationTips: [
                    "Present an outgoing and friendly stance, but don't get drawn entirely into the Yellow Party.",
                    "Make your visit personal : remember the Yellow's overriding interest in relationships.",
                    "Stress the importance of benefits that offer popularity, a chance to do something for other people, and happiness.",
                    "While focusing on business, make sure it's loose enough to allow some deviation.",
                    "Don't take the Yellow's enthusiasm at face value; 'yes's can cloak serious doubts. Root out the doubts, dig deep.",
                    "Rely on closed-ended questions; summarise and make reflective statement. Do not use open-ended questions."
                ],
                fullSummary: {
                    "Behaviour Pattern": "Open/Direct",
                    "Appearance": "Fashionable, Stylish",
                    "Work-Space": "Stimulating, Personal, Cluttered, Friendly",
                    "Pace": "Fast/Spontaneous",
                    "Priority": "Relationships: interacting",
                    "Fears": "Loss of prestige",
                    "Under Tension Will": "Attack/Be sarcastic",
                    "Seeks": "Recognition",
                    "Needs to Know (Benefits)": "How it enhances their status. Who else uses it.",
                    "Gains Security By": "Status",
                    "Wants to Maintain": "Ideas",
                    "Support Their": "Feelings",
                    "Achieves Acceptance By": "Playfulness, Stimulating environment",
                    "Likes You to Be": "Stimulating",
                    "Wants to Be": "Admired",
                    "Irritated By": "Boredom, Routine",
                    "Measures Personal Worth By": "Acknowledgement, Recognition, Applause, Compliments",
                    "Decisions Are": "Spontaneous"
                }
            }
        };

        // --- QUESTION DATA ---
        const questionsData = [
            // Q1
            [
                { word: "Gentle, Kindly", color: "green" },
                { word: "Persuasive, Convincing", color: "yellow" },
                { word: "Humble, reserved", color: "blue" },
                { word: "Original, inventive", color: "red" }
            ],
            // Q2
            [
                { word: "Attractive, charming", color: "yellow" },
                { word: "Cooperative, agreeable", color: "blue" },
                { word: "Stubborn, unyielding", color: "red" },
                { word: "Pleasing, Pleasant", color: "green" }
            ],
            // Q3
            [
                { word: "Easily lead, follower", color: "blue" },
                { word: "Bold, daring", color: "red" },
                { word: "Loyal, faithful", color: "green" },
                { word: "Charming, delightful", color: "yellow" }
            ],
            // Q4
            [
                { word: "Open-minded, receptive", color: "blue" },
                { word: "Obliging, helpful", color: "green" },
                { word: "Will power, strong willed", color: "red" },
                { word: "Cheerful, joyful", color: "yellow" }
            ],
            // Q5
            [
                { word: "Jovial, jolting", color: "yellow" },
                { word: "Precise, exact", color: "blue" },
                { word: "Gutsy, brazen", color: "red" },
                { word: "Even tempered, calm", color: "green" }
            ],
            // Q6
            [
                { word: "Competitive, seeking to win", color: "red" },
                { word: "Considerate, caring, thoughtful", color: "green" },
                { word: "Outgoing, fun loving", color: "yellow" },
                { word: "Harmonious, agreeable", color: "blue" }
            ],
            // Q7
            [
                { word: "Fussy, hard to please", color: "blue" },
                { word: "Obedient, dutiful", color: "green" },
                { word: "Unconquerable, determined", color: "red" },
                { word: "Playful, full of fun", color: "yellow" }
            ],
            // Q8
            [
                { word: "Brave, courageous", color: "red" },
                { word: "Inspiring, motivating", color: "yellow" },
                { word: "Submissive, yielding", color: "green" },
                { word: "Timid, shy quiet", color: "blue" }
            ],
            // Q9
            [
                { word: "Sociable", color: "yellow" },
                { word: "Patient", color: "green" },
                { word: "Self reliant, independent", color: "red" },
                { word: "Mild, reserved", color: "blue" }
            ],
            // Q10
            [
                { word: "Adventurous", color: "red" },
                { word: "Receptive, open to suggestions", color: "green" },
                { word: "Warm, friendly", color: "yellow" },
                { word: "Moderate", color: "blue" }
            ],
            // Q11
            [
                { word: "Talkative, chatty", color: "yellow" },
                { word: "Controlled, restrained", color: "green" },
                { word: "Conventional", color: "blue" },
                { word: "Decisive, certain", color: "red" }
            ],
            // Q12
            [
                { word: "Polished, smooth talker", color: "yellow" },
                { word: "Daring, risk-taker", color: "red" },
                { word: "Diplomatic, tactful", color: "blue" },
                { word: "Satisfied, content", color: "green" }
            ],
            // Q13
            [
                { word: "Aggressive, challenger", color: "red" },
                { word: "Outgoing, entertaining", color: "yellow" },
                { word: "Easy mark, easily taken advantage of", color: "green" },
                { word: "Fearful, afraid", color: "blue" }
            ],
            // Q14
            [
                { word: "Cautious, wary", color: "blue" },
                { word: "Determined, decided", color: "red" },
                { word: "Convincing, assuring", color: "yellow" },
                { word: "Good-natured, pleasant", color: "green" }
            ],
            // Q15
            [
                { word: "Willing, compliant", color: "green" },
                { word: "Eager, anxious", color: "yellow" },
                { word: "Agreeable, Consenting", color: "blue" },
                { word: "High-spirited, lively, enthusiastic", color: "red" }
            ],
            // Q16
            [
                { word: "Confident, assured", color: "yellow" },
                { word: "Sympathetic, compassionate", color: "green" },
                { word: "Tolerant", color: "blue" },
                { word: "Assertive, aggressive", color: "red" }
            ],
            // Q17
            [
                { word: "Well disciplined, self-controlled", color: "blue" },
                { word: "Generous, willing to share", color: "green" },
                { word: "Animated, uses gestures for expression", color: "yellow" },
                { word: "Persistent, unrelenting", color: "red" }
            ],
            // Q18
            [
                { word: "Brave, courageous", color: "red" },
                { word: "Inspiring, motivating", color: "yellow" },
                { word: "Submissive, yielding", color: "blue" },
                { word: "Timid, shy quiet", color: "green" }
            ],
            // Q19
            [
                { word: "Respectful", color: "blue" },
                { word: "Pioneering, exploring", color: "red" },
                { word: "Optimistic, positive", color: "yellow" },
                { word: "Accommodating, willing to please", color: "green" }
            ],
            // Q20
            [
                { word: "Argumentative, Controlling", color: "red" },
                { word: "Adaptable, flexible", color: "green" },
                { word: "Nonchalant, indifferent", color: "blue" },
                { word: "Light-hearted, carefree", color: "yellow" }
            ],
            // Q21
            [
                { word: "Trusting, faith in others", color: "yellow" },
                { word: "Contented, satisfied", color: "green" },
                { word: "Positive, sure", color: "red" },
                { word: "Peaceful, tranquil", color: "blue" }
            ],
            // Q22
            [
                { word: "Good mixer, sociable", color: "yellow" },
                { word: "Educated, Knowledgeable", color: "blue" },
                { word: "Vigorous, energetic", color: "red" },
                { word: "Lenient", color: "green" }
            ],
            // Q23
            [
                { word: "Companionable", color: "yellow" },
                { word: "Accurate, correct", color: "blue" },
                { word: "Outspoken, speaks freely", color: "red" },
                { word: "Restrained, reserved, controlled", color: "green" }
            ],
            // Q24
            [
                { word: "Restless, unable to rest or relax", color: "red" },
                { word: "Neighborly, friendly", color: "green" },
                { word: "Popular, liked by many", color: "yellow" },
                { word: "Neat, organized", color: "blue" }
            ]
        ];

        // --- QUESTION CARD FUNCTIONS ---

        function createDraggableWord(word, color) {
            const wordDiv = document.createElement('div');
            wordDiv.className = 'draggable-word';
            wordDiv.draggable = true;
            wordDiv.textContent = word;
            wordDiv.dataset.color = color;
            return wordDiv;
        }

        function createQuestionCard(questionWords, index) {
            const card = document.createElement('div');
            card.className = 'question-card bg-white border border-gray-200 rounded-lg p-5 shadow-sm';
            card.dataset.questionId = index;
            card.dataset.status = 'invalid'; // Invalid by default
            
            if (index !== 0) {
                card.style.display = 'none';
            }
            
            // Create word bank items
            const wordBankWords = questionWords.map(item => createDraggableWord(item.word, item.color).outerHTML).join('');

            card.innerHTML = `
                <h2 class="text-xl font-semibold text-gray-900 mb-2">Question ${index + 1}</h2>
                <p class="text-gray-600 mb-4 text-sm">Drag the words from the "Word Choices" (left) into "Your Order" slots (right).</p>
                <div class="flex flex-col md:flex-row gap-6">
                    
                    <!-- Left Column: Word Bank -->
                    <div class="flex-1">
                         <h3 class="font-semibold text-gray-700">Word Choices:</h3>
                         <div class="word-bank-dropzone mt-2">
                            ${wordBankWords}
                         </div>
                    </div>
                    
                    <!-- Right Column: Rank Spots -->
                    <div class="flex-1 space-y-3">
                        <h3 class="font-semibold text-gray-700">Your Order:</h3>
                        <div class="drop-spot" data-rank="1">
                            <span class="drop-spot-label">1st Place</span>
                            <span class="drop-spot-subtext">(Most like you)</span>
                        </div>
                        <div class="drop-spot" data-rank="2">
                            <span class="drop-spot-label">2nd Place</span>
                        </div>
                        <div class="drop-spot" data-rank="3">
                            <span class="drop-spot-label">3rd Place</span>
                        </div>
                        <div class="drop-spot" data-rank="4">
                            <span class="drop-spot-label">4th Place</span>
                            <span class="drop-spot-subtext">(Least like you)</span>
                        </div>
                    </div>
                    
                </div>
                <div class="error-message text-red-600 text-sm font-medium mt-3 h-5"></div>
            `;
            return card;
        }

        // --- NAVIGATION FUNCTION ---

        function showQuestion(index) {
            const allCards = document.querySelectorAll('.question-card');
            allCards.forEach(card => {
                card.style.display = 'none';
            });
            if (allCards[index]) {
                allCards[index].style.display = 'block';
            }
            questionCounter.textContent = `Question ${index + 1} of ${totalQuestions}`;
            prevButton.disabled = (index === 0);
            
            if (index === totalQuestions - 1) {
                nextButton.style.display = 'none';
                saveButton.style.display = 'inline-flex';
                // Final check for all cards before enabling save
                checkFormCompletion(true);
            } else {
                nextButton.style.display = 'inline-flex';
                saveButton.style.display = 'none';
                // Check current card to enable next
                checkFormCompletion(false);
            }
        }

        // --- VALIDATION FUNCTIONS ---

        function validateCard(card) {
            const bank = card.querySelector('.word-bank-dropzone');
            const wordsLeft = bank.querySelectorAll('.draggable-word').length;
            const errorMessage = card.querySelector('.error-message');
            
            if (wordsLeft === 0) {
                card.dataset.status = 'valid';
                if (errorMessage) errorMessage.textContent = '';
                return true;
            } else {
                card.dataset.status = 'invalid';
                if (errorMessage) errorMessage.textContent = `You still need to assign ${wordsLeft} words.`;
                return false;
            }
        }

        function checkFormCompletion(checkAll = false) {
            const allCards = document.querySelectorAll('.question-card');
            if (checkAll) {
                // Check all cards for the final save button
                let allValid = true;
                allCards.forEach(card => {
                    if (card.dataset.status !== 'valid') {
                        allValid = false;
                    }
                });
                saveButton.disabled = !allValid;
            } else {
                // Check only the current card for the 'next' button
                const currentCard = allCards[currentQuestionIndex];
                if (currentCard) {
                    nextButton.disabled = (currentCard.dataset.status === 'invalid');
                }
            }
        }

        // --- CALCULATION & CHARTING FUNCTIONS ---

        // Collects scores AND ranked word list
        function collectRankedWords() {
            const pointMap = { "1": 10, "2": 6, "3": 3, "4": 1 };
            let scores = { blue: 0, red: 0, green: 0, yellow: 0 };
            // This will hold all words, sorted by color
            let rankedWords = { 
                blue: [], 
                red: [], 
                green: [], 
                yellow: [] 
            };
            
            const allCards = document.querySelectorAll('.question-card');
            
            allCards.forEach(card => {
                const spots = card.querySelectorAll('.drop-spot');
                spots.forEach(spot => {
                    const rank = spot.dataset.rank; // "1", "2", "3", "4"
                    const word = spot.querySelector('.draggable-word');
                    if (word) {
                        const color = word.dataset.color;
                        const points = pointMap[rank];
                        if (color && points != null) {
                            // 1. Add to total score
                            scores[color] += points;
                            // 2. Add to ranked word list
                            rankedWords[color].push({
                                text: word.textContent,
                                rank: rank
                            });
                        }
                    }
                });
            });
            
            // Sort each color's word list by rank
            for (const color in rankedWords) {
                rankedWords[color].sort((a, b) => a.rank - b.rank);
            }
            
            return { scores, rankedWords };
        }
        
        // --- Function to populate Key Words ---
        function populateWordAnalysis(scores, rankedWords) { 
            const colors = ['blue', 'red', 'green', 'yellow'];
            let capacities = {};
            let wordsToDisplay = {};

            // 1. Calculate capacity and get words for all colors FIRST
            colors.forEach(color => {
                const wordCapacity = Math.floor(scores[color] / 20);
                capacities[color] = wordCapacity;
                wordsToDisplay[color] = rankedWords[color].slice(0, wordCapacity);
            });

            // 2. Calculate grid proportions
            const totalWords = capacities.blue + capacities.red + capacities.green + capacities.yellow;
            let topRowFr, bottomRowFr, leftColFr, rightColFr;

            if (totalWords === 0) {
                topRowFr = 1; bottomRowFr = 1; leftColFr = 1; rightColFr = 1;
            } else {
                const topRowWords = capacities.blue + capacities.red;
                const bottomRowWords = capacities.green + capacities.yellow;
                const leftColWords = capacities.blue + capacities.green;
                const rightColWords = capacities.red + capacities.yellow;
                topRowFr = topRowWords || 1;
                bottomRowFr = bottomRowWords || 1;
                leftColFr = leftColWords || 1;
                rightColFr = rightColWords || 1;
            }

            // 3. Apply proportions to the grid container
            const gridContainer = document.getElementById('key-words-grid');
            if (gridContainer) {
                gridContainer.style.gridTemplateRows = `${topRowFr}fr ${bottomRowFr}fr`;
                gridContainer.style.gridTemplateColumns = `${leftColFr}fr ${rightColFr}fr`;
            }

            // 4. Now, populate the HTML for each box
            colors.forEach(color => {
                const container = document.getElementById(`${color}-key-words`);
                if (!container) return;
                const currentWords = wordsToDisplay[color]; // This is an array

                if (currentWords.length === 0) {
                     if (scores[color] > 0) {
                        container.innerHTML = `<p class="text-sm italic text-gray-600">No words to display at this point level.</p>`;
                    } else {
                        container.innerHTML = `<p class="text-sm italic text-gray-600">No score for this color.</p>`;
                    }
                    return;
                }

                // 5. Create the simple bulleted list
                const listHtml = currentWords.map(word => {
                    return `<li class="key-word-rank-${word.rank}">${word.text}</li>`;
                }).join('');
                
                container.innerHTML = `<ul class="list-disc list-inside space-y-1">${listHtml}</ul>`;
            });
        }
        
        // --- CHART: PIE CHART ---
        function drawPieChart(scores) {
            const container = document.getElementById('pie-chart-container');
            if (!container) return;
            const width = container.clientWidth;
            const height = container.clientHeight;
            const radius = Math.min(width, height) / 2 * 0.9;
            const innerRadius = 0; 

            const svg = d3.select("#pie-chart")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");
            svg.html("");

            const chartGroup = svg.append("g")
                .attr("transform", `translate(${width / 2}, ${height / 2})`);

            const data = [
                { name: "Blue", value: scores.blue, color: "#3B82F6" },
                { name: "Red", value: scores.red, color: "#EF4444" },
                { name: "Green", value: scores.green, color: "#22C55E" },
                { name: "Yellow", value: scores.yellow, color: "#FACC15" }
            ].filter(d => d.value > 0);

            if (data.length === 0) return; 

            const total = d3.sum(data, d => d.value);

            const pie = d3.pie().value(d => d.value).sort(null);
            const arc = d3.arc().innerRadius(innerRadius).outerRadius(radius);

            const arcs = chartGroup.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => d.data.color)
                .attr("stroke", "white")
                .style("stroke-width", "2px");

            arcs.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("dy", "0.35em")
                .attr("fill", "white")
                .attr("text-anchor", "middle")
                .style("font-size", "1.1rem")
                .style("font-weight", "600")
                .style("text-shadow", "0 0 3px rgba(0,0,0,0.7)")
                .text(d => {
                    if (total === 0) return "0%";
                    const percent = (d.data.value / total) * 100;
                    return `${percent.toFixed(0)}%`;
                });
        }

        // --- CHART: QUADRANT CHART (RECTANGLE) ---
        function drawQuadrantChartRectangle(scores) {
            const chartContainer = document.getElementById('quadrant-chart-rect-container');
            if (!chartContainer) return;
            const width = chartContainer.clientWidth;
            const height = chartContainer.clientHeight;
            
            const svg = d3.select("#quadrant-chart-rect")
                .attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");
            svg.html("");

            const centerX = width / 2;
            const centerY = height / 2;

            const data = [
                { name: "Blue", value: scores.blue, color: "#3B82F6", quadrant: 'top-left' },
                { name: "Red", value: scores.red, color: "#EF4444", quadrant: 'top-right' },
                { name: "Green", value: scores.green, color: "#22C55E", quadrant: 'bottom-left' },
                { name: "Yellow", value: scores.yellow, color: "#FACC15", quadrant: 'bottom-right' }
            ];

            const maxPossibleScore = 240;
            const maxPossibleSide = Math.sqrt(maxPossibleScore);
            const maxRadius = Math.min(width / 2, height / 2) * 0.95; 
            const scale = maxRadius / maxPossibleSide; 

            const averageScore = 120;
            const averageSide = Math.sqrt(averageScore);
            const averageScaledSide = averageSide * scale;

            const chartGroup = svg.append("g")
                .attr("transform", `translate(${centerX}, ${centerY})`);

            // --- Draw the squares FIRST ---
            data.forEach(d => {
                d.side = Math.sqrt(d.value);
                const scaledSide = d.side * scale; 

                let x, y, textX, textY;
                switch (d.quadrant) {
                    case 'top-left': x = -scaledSide; y = -scaledSide; textX = -scaledSide / 2; textY = -scaledSide / 2; break;
                    case 'top-right': x = 0; y = -scaledSide; textX = scaledSide / 2; textY = -scaledSide / 2; break;
                    case 'bottom-left': x = -scaledSide; y = 0; textX = -scaledSide / 2; textY = scaledSide / 2; break;
                    case 'bottom-right': x = 0; y = 0; textX = scaledSide / 2; textY = scaledSide / 2; break;
                }

                chartGroup.append("rect")
                    .attr("x", x)
                    .attr("y", y)
                    .attr("width", scaledSide)
                    .attr("height", scaledSide)
                    .attr("fill", d.color);

                if (scaledSide > 60) {
                    chartGroup.append("text")
                        .attr("class", "chart-label-title")
                        .attr("x", textX)
                        .attr("y", textY - 10)
                        .text(d.name);
                    chartGroup.append("text")
                        .attr("class", "chart-label-score")
                        .attr("x", textX)
                        .attr("y", textY + 16)
                        .text(d.value);
                }
            });

            // --- Draw the axes to divide colors ---
            const axisColor = "#4b5563"; // gray-600
            const axisWidth = 2;
            
            chartGroup.append("line")
                .attr("x1", 0).attr("y1", -maxRadius)
                .attr("x2", 0).attr("y2", maxRadius)
                .attr("stroke", axisColor).attr("stroke-width", axisWidth);

            chartGroup.append("line")
                .attr("x1", -maxRadius).attr("y1", 0)
                .attr("x2", maxRadius).attr("y2", 0)
                .attr("stroke", axisColor).attr("stroke-width", axisWidth);

            // --- Draw the average RECTANGLE LAST (so it's on top) ---
            chartGroup.append("rect")
                .attr("x", -averageScaledSide)
                .attr("y", -averageScaledSide)
                .attr("width", averageScaledSide * 2)
                .attr("height", averageScaledSide * 2)
                .attr("fill", "none")
                .attr("stroke", "#6b7280") // gray-500
                .attr("stroke-width", 2)
                .attr("stroke-dasharray", "4 4"); // Make it dashed
        }
        
        // --- NEW: RESULT PAGE BUILDER FUNCTIONS ---
        function getDominantColor(scores) {
            let dominantColor = 'blue'; // Default
            let maxScore = 0;
            for (const color in scores) {
                if (scores[color] > maxScore) {
                    maxScore = scores[color];
                    dominantColor = color;
                }
            }
            return dominantColor;
        }

        function buildPersonalizedReport(scores, rankedWords, dominantColor) {
            const data = profileDataStore[dominantColor];
            const colorClass = `text-${dominantColor}-600`;
            
            // 1. Profile Title
            const titleContainer = document.getElementById('profile-title-container');
            titleContainer.innerHTML = `
                <h1 class="text-4xl md:text-5xl font-bold ${colorClass}">${data.title}</h1>
                <p class="text-lg text-gray-600 mt-2">${data.summary}</p>
            `;

            // 2. At a Glance
            const glanceContainer = document.getElementById('at-a-glance-container');
            const glanceItems = Object.entries(data.atAGlance).map(([key, value]) => {
                return `<div class="bg-gray-100 p-3 rounded-lg shadow-sm">
                            <dt class="text-sm font-medium text-gray-500">${key}</dt>
                            <dd class="text-lg font-semibold text-gray-900">${value}</dd>
                        </div>`;
            }).join('');
            glanceContainer.innerHTML = `
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">At a Glance</h2>
                <dl class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    ${glanceItems}
                </dl>
            `;

            // 3. Key Word Quadrant (This is called separately)
            populateWordAnalysis(scores, rankedWords);

            // 4. Strengths & Blind Spots
            const strengthsContainer = document.getElementById('strengths-blindspots-container');
            const strengthsHtml = data.strengths.map(item => `<li class="text-gray-700">${item}</li>`).join('');
            const blindSpotsHtml = data.blindSpots.map(item => `<li class="text-gray-700">${item}</li>`).join('');
            strengthsContainer.innerHTML = `
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Strengths & Potential Blind Spots</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-px bg-gray-300 rounded-lg shadow-md overflow-hidden">
                    <div class="bg-green-100 p-6">
                        <h3 class="text-2xl font-bold text-green-800 mb-4">Your Strengths</h3>
                        <ul class="list-disc list-inside space-y-1">
                            ${strengthsHtml}
                        </ul>
                    </div>
                    <div class="bg-red-100 p-6">
                        <h3 class="text-2xl font-bold text-red-800 mb-4">Potential Blind Spots</h3>
                        <ul class="list-disc list-inside space-y-1">
                            ${blindSpotsHtml}
                        </ul>
                    </div>
                </div>
            `;

            // 5. Communication
            const commContainer = document.getElementById('communication-container');
            const commTipsHtml = data.communicationTips.map(item => `<li class="text-gray-800">${item}</li>`).join('');
            commContainer.innerHTML = `
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">How to Communicate with ${data.title}s</h2>
                <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                    <ul class="list-disc list-inside space-y-2">
                        ${commTipsHtml}
                    </ul>
                </div>
            `;

            // 6. Highlight Analysis Grid (REMOVED)
            // highlightAnalysis(dominantColor);
            
            // 7. NEW: Activate the Style Explorer
            activateStyleExplorer(dominantColor);
        }

        // --- NEW: Style Explorer Functions ---
        function activateStyleExplorer(dominantColor) {
            const tabs = styleExplorerTabs.querySelectorAll('.style-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => showStyleSummary(tab.dataset.color));
            });
            // Auto-select the dominant color
            showStyleSummary(dominantColor);
        }
        
        function showStyleSummary(color) {
            // 1. Update Tab Active State
            styleExplorerTabs.querySelectorAll('.style-tab').forEach(tab => {
                tab.classList.remove('active-blue', 'active-red', 'active-green', 'active-yellow');
                if (tab.dataset.color === color) {
                    tab.classList.add(`active-${color}`);
                }
            });

            // 2. Get data
            const data = profileDataStore[color].fullSummary;
            if (!data) {
                styleExplorerContent.innerHTML = `<p>Error: No data found for ${color}.</p>`;
                return;
            }

            // 3. Build HTML
            const summaryItems = Object.entries(data).map(([key, value]) => {
                return `<div class="bg-white p-4 rounded-lg shadow-sm">
                            <dt class="text-sm font-medium text-gray-500">${key}</dt>
                            <dd class="text-lg font-semibold text-gray-900">${value}</dd>
                        </div>`;
            }).join('');
            
            styleExplorerContent.innerHTML = `
                <dl class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    ${summaryItems}
                </dl>
            `;
        }
        
        // --- DRAG AND DROP HANDLERS ---
        
        function handleDragStart(e) {
            const target = e.target.closest('.draggable-word');
            if (!target) return;
            
            draggedItem = target;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', target.textContent); // Necessary for Firefox
            setTimeout(() => target.classList.add('dragging'), 0);
        }

        function handleDragEnd(e) {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
            draggedItem = null; // Always clear on dragend
            document.querySelectorAll('.highlight').forEach(el => el.classList.remove('highlight'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            const dropzone = e.target.closest('.drop-spot, .word-bank-dropzone');
            if (dropzone) {
                if (dropzone.classList.contains('drop-spot') && dropzone.children.length > 1 && draggedItem && draggedItem.parentElement !== dropzone) {
                    // This is a full spot, don't highlight
                } else {
                    dropzone.classList.add('highlight');
                }
            }
        }

        function handleDragLeave(e) {
            const dropzone = e.target.closest('.drop-spot, .word-bank-dropzone');
            if (dropzone) {
                dropzone.classList.remove('highlight');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            
            if (!draggedItem) return; 
            const itemToDrop = draggedItem; 
            draggedItem = null; 
            itemToDrop.classList.remove('dragging'); 

            const dropzone = e.target.closest('.drop-spot, .word-bank-dropzone');
            if (!dropzone) return; 

            dropzone.classList.remove('highlight');
            const card = dropzone.closest('.question-card');
            
            if (dropzone.classList.contains('drop-spot')) {
                if (dropzone.children.length > 1) { 
                    const existingWord = dropzone.querySelector('.draggable-word');
                    if (existingWord && existingWord !== itemToDrop) { 
                        card.querySelector('.word-bank-dropzone').appendChild(existingWord);
                    }
                }
                dropzone.appendChild(itemToDrop); 
                dropzone.classList.add('drop-spot-filled');
            }
            
            if (dropzone.classList.contains('word-bank-dropzone')) {
                const originalSpot = itemToDrop.closest('.drop-spot'); 
                if (originalSpot) {
                    originalSpot.classList.remove('drop-spot-filled');
                }
                dropzone.appendChild(itemToDrop); 
            }
            
            if (card) {
                validateCard(card);
                
                if (currentQuestionIndex === totalQuestions - 1) {
                    checkFormCompletion(true);
                } else {
                    checkFormCompletion(false);
                }
            }
        }


        // --- INITIALIZATION & EVENT LISTENERS ---

        function initialize() {
            // Render all questions
            questionsData.forEach((words, index) => {
                const card = createQuestionCard(words, index);
                questionsContainer.appendChild(card);
            });
            
            showQuestion(currentQuestionIndex);

            // --- Global Drag and Drop Listeners ---
            document.addEventListener('dragstart', handleDragStart);
            document.addEventListener('dragend', handleDragEnd);
            document.addEventListener('dragover', handleDragOver);
            document.addEventListener('dragleave', handleDragLeave);
            document.addEventListener('drop', handleDrop);

            // --- Button Listeners ---
            saveButton.addEventListener('click', () => {
                checkFormCompletion(true); // Final check
                if (!saveButton.disabled) {
                    
                    const { scores, rankedWords } = collectRankedWords();
                    const dominantColor = getDominantColor(scores);
                    
                    testPage.classList.add('hidden');
                    resultsPage.classList.remove('hidden');

                    setTimeout(() => {
                        // --- NEW ORDER ---
                        // 1. Draw Pie Chart (First)
                        drawPieChart(scores); 
                        // 2. Draw Quadrant Chart
                        drawQuadrantChartRectangle(scores); 
                        
                        // 3. Build the rest of the report (which now includes the explorer)
                        buildPersonalizedReport(scores, rankedWords, dominantColor);
                        // --- END NEW ORDER ---
                    }, 10); 

                    successMessage.textContent = 'Answers saved and results calculated!';
                    setTimeout(() => { successMessage.textContent = ''; }, 3000);
                }
            });

            backToTestButton.addEventListener('click', () => {
                resultsPage.classList.add('hidden');
                testPage.classList.remove('hidden');
            });
            
            nextButton.addEventListener('click', () => {
                if (currentQuestionIndex < totalQuestions - 1) {
                    currentQuestionIndex++;
                    showQuestion(currentQuestionIndex);
                }
            });

            prevButton.addEventListener('click', () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    showQuestion(currentQuestionIndex);
                }
            });

            devFillButton.addEventListener('click', () => {
                const allCards = document.querySelectorAll('.question-card');
                allCards.forEach(card => {
                    const wordBank = card.querySelector('.word-bank-dropzone');
                    const spots = card.querySelectorAll('.drop-spot');
                    const words = Array.from(wordBank.querySelectorAll('.draggable-word'));
                    
                    // Shuffle words
                    for (let i = words.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [words[i], words[j]] = [words[j], words[i]];
                    }
                    
                    // Place words in spots
                    words.forEach((word, index) => {
                        if (spots[index]) {
                            spots[index].appendChild(word);
                            spots[index].classList.add('drop-spot-filled');
                        }
                    });
                    validateCard(card);
                });

                successMessage.textContent = 'All answers randomly filled!';
                setTimeout(() => { successMessage.textContent = ''; }, 3000);
                
                currentQuestionIndex = totalQuestions - 1;
                showQuestion(currentQuestionIndex);
            });
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
